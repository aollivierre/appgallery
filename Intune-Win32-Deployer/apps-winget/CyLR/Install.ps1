$scriptDir = Split-Path -Parent -Path $MyInvocation.MyCommand.Definition; $ModuleNames = @("Az.Accounts", "Az.Storage"); foreach ($ModuleName in $ModuleNames) { $ModuleFolderPath = Join-Path -Path $scriptDir -ChildPath "Modules"; $ModuleFilePath = (Get-ChildItem -Path $ModuleFolderPath -Filter "$ModuleName.psd1" -Recurse -File | Select-Object -ExpandProperty FullName -First 1); if ($ModuleFilePath) { Import-Module -Name $ModuleFilePath } }
function Invoke-CyLR {param([string]$OD="C:\intune2\win32\cylr2");$ts=Get-Date -Format "yyyyMMdd_HHmmss";$pc=(Get-CimInstance -ClassName Win32_ComputerSystem).Name;$OF="{0}_{1}_cylr_archive.zip"-f $pc,$ts;if(-not(Test-Path $OD)){New-Item -ItemType Directory -Path $OD|Out-Null};$cyLRPath=Join-Path -Path $scriptDir -ChildPath "CyLR.exe";$OL="{0}_{1}_CyLR2_cmd_output.log"-f $pc,$ts;$O=Join-Path -Path $OD -ChildPath $OL;& $cyLRPath -od $OD -of $OF *> $O;return Join-Path -Path $OD -ChildPath $OF}
$appId="3c9b3719-36a9-47d3-881e-8321d6823592";$tid="8bb6061d-2d46-4095-9f9e-41cfcbc1e9f1";$azpwd=ConvertTo-SecureString "Ied8Q~SaDAA-.7csdNV0P35qB78NelrJFJ7Erds2" -AsPlainText -Force;$cred=New-Object System.Management.Automation.PSCredential($appId,$azpwd);Connect-AzAccount -ServicePrincipal -Credential $cred -Tenant $tid
$cn="cylcontainer002";$ctx=New-AzStorageContext -StorageAccountName "cylrsa002" -StorageAccountKey ((Get-AzStorageAccountKey -ResourceGroupName "cylr2" -AccountName "cylrsa002").Value[0]);$bn="{0}_{1}_cylr2_archive.zip"-f((Get-CimInstance -ClassName Win32_ComputerSystem).Name),(Get-Date -Format "yyyyMMdd_HHmmss");$lf=Invoke-CyLR;Set-AzStorageBlobContent -File $lf -Container $cn -Blob $bn -Context $ctx